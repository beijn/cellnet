#!/bin/bash
# NOTE this is designed to run in the repo root
# it saves the current state of the repo and submits the job

STARTTIME="$(date +%y%m%d-%H%M%S)"
INPUT="$1"
EXPERIMENT="$2"
RELEASE_MODE="$3"

NAME="$(basename "$INPUT" .py)"
INDIR="$(dirname "$INPUT")"; if [ "$INDIR" =  "" ]; then INDIR="."; fi
OUTDIR="./results/$INDIR/$NAME/$STARTTIME-$EXPERIMENT"
if [ "$RELEASE_MODE" != "" ]; then OUTDIR="$OUTDIR-$RELEASE_MODE"; fi
OUTDIR="$OUTDIR-RUNNING"

mkdir -p "$OUTDIR"
rsync -a "." "$OUTDIR" --exclude .git --exclude results

INPUT="$OUTDIR/$NAME.py"
mv "$OUTDIR/$INDIR/$NAME.py" "$INPUT" 2>/dev/null

out="$(sbatch -J "$EXPERIMENT" bin/ipynb "$NAME" "$INDIR" "$INPUT" "$OUTDIR" "$EXPERIMENT" "$RELEASE_MODE")"
echo -e "\033[1;32m$out $NAME:$EXPERIMENT ($RELEASE_MODE) at $STARTTIME\033[0m"
